# 🎯 架構決策指南

> **本文件用於快速回顧關鍵技術選擇的原因**

---

## 1. 搜尋工具選擇

### ✅ 當前方案：Tavily + DuckDuckGo Text Search

**為什麼不用 Playwright 爬蟲？**

| 維度 | Tavily/DDGS | Playwright |
|------|-------------|------------|
| **回應速度** | < 1 秒 | 3-5 秒（啟動瀏覽器） |
| **記憶體需求** | < 100MB | > 1GB |
| **Cloud Run 相容性** | ✅ 完美支援 | ❌ 不相容（需要 GUI 依賴） |
| **部署複雜度** | 簡單（純 Python） | 複雜（需要系統庫） |
| **適用場景** | 辯論摘要（90%） | 深度內容分析（10%） |
| **成本** | 免費額度充足 | 需要更大實例 |

**結論**：
- ✅ **Phase 1-3**：使用 Tavily + DDGS（速度快、符合辯論節奏）
- 🔵 **Phase 4+**：可選擇性加入 Playwright 作為獨立服務（深度爬取）

---

## 2. 架構模式選擇

### 情境 A：即時辯論（本專案 MVP）

```
使用者
  ↓
前端 (Cloudflare Pages)
  ↓
後端 API (Cloud Run - 512MB)
  ├─ LangGraph (辯論邏輯)
  ├─ Groq LLM (AI 推理)
  └─ Tavily/DDGS (搜尋工具)
```

**優點**：
- 🚀 部署簡單，一個 Docker 容器搞定
- ⚡ 回應速度快（< 1 秒開始串流）
- 💰 完全免費（Cloud Run 免費額度）
- 🎯 符合辯論「你來我往」的節奏

**適用於**：
- 展示 Multi-Agent 協作能力
- 證明 LangGraph 狀態管理技能
- 展示即時串流技術

---

### 情境 B：深度研究（進階擴展）

```
使用者
  ↓
前端 (Cloudflare Pages)
  ↓
主 API (Cloud Run - 512MB)          ← 辯論邏輯
  ↓
爬蟲服務 (Cloud Functions Gen2 - 2GB) ← Playwright 爬取
```

**優點**：
- 🎯 精準控制爬取邏輯
- 🛡️ 主服務與爬蟲隔離（爬蟲崩潰不影響辯論）
- 📊 可處理動態網站（SPA、付費牆）

**缺點**：
- ⏱️ 回應延遲（3-5 秒）
- 🔧 架構複雜度增加
- 💰 需要額外配置（Cloud Functions）

**適用於**：
- 分析特定長文（學術論文、白皮書）
- 爬取 Tavily 無法覆蓋的特殊網站
- 展示「深度研究」差異化功能

---

## 3. 何時使用哪種方案？

### 🟢 Phase 1-3：專注核心功能

**優先級**：
1. ✅ 完成基礎 SSE 串流
2. ✅ 實現雙 Agent 辯論
3. ✅ 整合 Tavily + DDGS 搜尋
4. ✅ 部署到 Cloud Run

**不要做**：
- ❌ 引入 Playwright（會拖累進度）
- ❌ 過度優化搜尋結果（Tavily 已經夠好）
- ❌ 嘗試複雜的微服務架構

---

### 🔵 Phase 4+：擴展進階功能

**考慮加入 Playwright 的時機**：
1. ✅ 基礎辯論功能已穩定運行
2. ✅ 你需要展示「與眾不同」的功能
3. ✅ 使用者有明確的「深度分析」需求
4. ✅ 你有時間維護兩個服務

**實作建議**：
- 創建獨立的 Cloud Function（不要塞在主 API）
- 只在使用者啟用「深度模式」時調用
- 設定合理的超時與錯誤處理

---

## 4. 快速決策流程圖

```
需要搜尋功能？
    ↓
   是
    ↓
需要爬取完整網頁內容？
    ↓
   否 → 使用 Tavily + DDGS（Phase 1-3）
    ↓
   是
    ↓
需要處理動態網站（SPA、JS 渲染）？
    ↓
   否 → 使用簡單的 HTTP 爬蟲（httpx + BeautifulSoup）
    ↓
   是 → 考慮 Playwright（Phase 4+）
    ↓
部署為獨立 Cloud Function（不要塞在主 API）
```

---

## 5. 關鍵原則

### ✅ DO（推薦做法）
1. **先求有，再求好**：Phase 1-3 專注核心功能
2. **保持輕量**：Cloud Run 512MB 足以處理 LLM + 搜尋
3. **分離關注點**：複雜功能（如爬蟲）獨立部署
4. **優雅降級**：搜尋失敗不會導致系統崩潰

### ❌ DON'T（避免陷阱）
1. **過早優化**：不要在 Phase 1 就引入 Playwright
2. **忽略成本**：Playwright 需要更大的記憶體實例
3. **混合部署**：不要把爬蟲塞在主 API（會拖累啟動速度）
4. **忽略 UX**：辯論卡頓 5 秒等爬蟲，使用者會不耐煩

---

## 6. 成本對比

### 方案 A：Tavily + DDGS（當前方案）
```
Cloud Run (512MB)：免費額度內
Tavily API：1000 次/月免費
DDGS：完全免費

總成本：$0/月
```

### 方案 B：加入 Playwright（進階擴展）
```
Cloud Run (512MB)：免費額度內
Cloud Functions Gen2 (2GB)：免費額度內（200 萬次請求）
Tavily API：1000 次/月免費

總成本：$0/月（在免費額度內）
單次爬取延遲：+3-5 秒
```

---

## 7. 總結

**一句話摘要**：
> **現階段使用 Tavily + DDGS 即可滿足 90% 的辯論需求，Playwright 留作 Phase 4 的「深度研究」差異化功能。**

**記住**：
- 🎯 辯論重點是「你來我往的節奏」，不是「完整的網頁內容」
- ⚡ 速度 > 完整性（1 秒摘要 > 5 秒全文）
- 💰 免費 > 付費（Cloud Run 512MB > 2GB）
- 🚀 簡單 > 複雜（單一服務 > 微服務架構）

**開始行動**：
1. 從 Phase 0 開始建立專案骨架
2. Phase 1 驗證 SSE 串流
3. Phase 2 實現雙 Agent 辯論
4. Phase 3 整合 Tavily + DDGS
5. Phase 4（選做）加入 Playwright 深度爬取

---

**最後更新**：2025-12-04
**文件狀態**：✅ 最終版本
