# ğŸš€ DebateAI éƒ¨ç½²æŒ‡å—

## å‰ç½®éœ€æ±‚

- Node.js 18+
- Python 3.11+
- [uv](https://docs.astral.sh/uv/) (Python å¥—ä»¶ç®¡ç†)
- [Wrangler CLI](https://developers.cloudflare.com/workers/wrangler/) (Cloudflare)
- [gcloud CLI](https://cloud.google.com/sdk/docs/install) (Google Cloud)

---

## ğŸŒ å‰ç«¯éƒ¨ç½² (Cloudflare Pages)

### âš ï¸ é‡è¦ï¼šç’°å¢ƒè®Šæ•¸å¿…é ˆåœ¨å»ºç½®æ™‚æ³¨å…¥

Next.js çš„ç’°å¢ƒè®Šæ•¸æ˜¯åœ¨**å»ºç½®æ™‚**ï¼ˆbuild timeï¼‰è€Œéé‹è¡Œæ™‚ï¼ˆruntimeï¼‰æ³¨å…¥åˆ°éœæ…‹æª”æ¡ˆä¸­ã€‚

**éŒ¯èª¤ç¤ºä¾‹**ï¼ˆæœƒå°è‡´å‰ç«¯é€£æ¥åˆ° localhostï¼‰ï¼š
```bash
# âŒ é€™æ¨£ä¸æœƒæ­£ç¢ºæ³¨å…¥ç’°å¢ƒè®Šæ•¸
npm run build
npx wrangler pages deploy out --project-name debate-ai
```

**æ­£ç¢ºç¤ºä¾‹**ï¼š
```bash
# âœ… æ–¹æ³• 1ï¼šä½¿ç”¨ .env.production æª”æ¡ˆ
cat > .env.production << 'EOF'
NEXT_PUBLIC_API_URL=https://debate-api-1046434677262.asia-east1.run.app
EOF

# æ¸…é™¤èˆŠå»ºç½®ï¼Œç¢ºä¿é‡æ–°å»ºç½®
rm -rf .next out

# å»ºç½®ï¼ˆæœƒè‡ªå‹•è®€å– .env.productionï¼‰
npm run build

# éƒ¨ç½²
npx wrangler pages deploy out --project-name debate-ai
```

```bash
# âœ… æ–¹æ³• 2ï¼šé¡¯å¼å‚³éç’°å¢ƒè®Šæ•¸
rm -rf .next out
NEXT_PUBLIC_API_URL=https://debate-api-1046434677262.asia-east1.run.app npm run build
npx wrangler pages deploy out --project-name debate-ai
```

### æ–¹æ³• 1ï¼šä½¿ç”¨ Wrangler CLIï¼ˆæ¨è–¦ï¼‰

```bash
cd frontend

# 1. å®‰è£ä¾è³´
npm install

# 2. ç¢ºä¿ .env.production å­˜åœ¨ä¸”æ­£ç¢º
cat > .env.production << 'EOF'
NEXT_PUBLIC_API_URL=https://debate-api-1046434677262.asia-east1.run.app
EOF

# 3. æ¸…é™¤èˆŠå»ºç½®ä¸¦é‡æ–°å»ºç½®
rm -rf .next out
npm run build

# 4. é©—è­‰å»ºç½®çµæœï¼ˆç¢ºä¿æ²’æœ‰ localhostï¼‰
if grep -r "localhost:8000" out/ 2>/dev/null; then
  echo "âŒ éŒ¯èª¤ï¼šå»ºç½®æª”æ¡ˆä¸­ä»åŒ…å« localhostï¼Œç’°å¢ƒè®Šæ•¸æœªæ­£ç¢ºæ³¨å…¥ï¼"
  exit 1
else
  echo "âœ… å»ºç½®æˆåŠŸï¼ŒAPI URL å·²æ­£ç¢ºæ³¨å…¥"
fi

# 5. éƒ¨ç½²åˆ° Cloudflare Pages
npx wrangler pages deploy out --project-name debate-ai
```

### æ–¹æ³• 2ï¼šGit è‡ªå‹•éƒ¨ç½²

1. å°‡ç¨‹å¼ç¢¼æ¨é€åˆ° GitHub
2. åœ¨ Cloudflare Dashboard é€£æ¥ GitHub repo
3. è¨­å®šï¼š
   - Build command: `npm run build`
   - Build output: `out`
   - Root directory: `frontend`
   - **Environment variables**ï¼ˆå¿…é ˆè¨­å®šï¼‰:
     - `NEXT_PUBLIC_API_URL` = `https://debate-api-1046434677262.asia-east1.run.app`

### ç’°å¢ƒè®Šæ•¸ (Cloudflare Dashboard)

| è®Šæ•¸                  | å€¼                                                    |
| --------------------- | ----------------------------------------------------- |
| `NEXT_PUBLIC_API_URL` | `https://debate-api-1046434677262.asia-east1.run.app` |

---

## â˜ï¸ å¾Œç«¯éƒ¨ç½² (Google Cloud Run)

### å¿«é€Ÿéƒ¨ç½²ï¼ˆå®Œæ•´ç’°å¢ƒè®Šæ•¸ç‰ˆæœ¬ï¼‰

```bash
cd backend

# æ–¹æ³• 1ï¼šå¾ .env æª”æ¡ˆè®€å–æ‰€æœ‰ç’°å¢ƒè®Šæ•¸
gcloud run deploy debate-api \
  --source . \
  --region asia-east1 \
  --set-env-vars GROQ_API_KEY=ä½ çš„GROQ_API_KEY,GROQ_MODEL=openai/gpt-oss-120b,TAVILY_API_KEY=ä½ çš„TAVILY_KEY,USE_LANGGRAPH=true,SUPABASE_SERVICE_ROLE_KEY=ä½ çš„SUPABASE_KEY,SUPABASE_URL=https://ä½ çš„å°ˆæ¡ˆ.supabase.co \
  --memory 512Mi \
  --cpu 1 \
  --timeout 300 \
  --min-instances 0 \
  --max-instances 3 \
  --allow-unauthenticated
```

### ç’°å¢ƒè®Šæ•¸

| è®Šæ•¸                         | èªªæ˜                | ç¯„ä¾‹                                      | å¿…è¦æ€§ |
| ---------------------------- | ------------------- | ----------------------------------------- | ------ |
| `GROQ_API_KEY`               | Groq API é‡‘é‘°       | `gsk_xxxx...`                             | âœ… å¿…é ˆ |
| `GROQ_MODEL`                 | ä½¿ç”¨çš„æ¨¡å‹          | `openai/gpt-oss-120b`                     | âœ… å¿…é ˆ |
| `TAVILY_API_KEY`             | Tavily æœå°‹ API     | `tvly-dev-xxxx...`                        | é¸å¡«   |
| `USE_LANGGRAPH`              | å•Ÿç”¨ LangGraph      | `true`                                    | âœ… å¿…é ˆ |
| `SUPABASE_SERVICE_ROLE_KEY`  | Supabase æœå‹™é‡‘é‘°   | `eyJhbGc...`                              | âœ… å¿…é ˆ |
| `SUPABASE_URL`               | Supabase å°ˆæ¡ˆ URL   | `https://xxx.supabase.co`                 | âœ… å¿…é ˆ |
| `ALLOWED_ORIGINS`            | CORS ç™½åå–®         | `https://debateai.roy422.ggff.net`        | é¸å¡«   |

### æ›´æ–°ç’°å¢ƒè®Šæ•¸

```bash
# æ›´æ–°å–®ä¸€ç’°å¢ƒè®Šæ•¸
gcloud run services update debate-api \
  --region asia-east1 \
  --set-env-vars GROQ_API_KEY=æ–°çš„é‡‘é‘°

# æ›´æ–°å¤šå€‹ç’°å¢ƒè®Šæ•¸
gcloud run services update debate-api \
  --region asia-east1 \
  --set-env-vars GROQ_MODEL=æ–°æ¨¡å‹,TAVILY_API_KEY=æ–°é‡‘é‘°

# æŸ¥çœ‹ç•¶å‰ç’°å¢ƒè®Šæ•¸
gcloud run services describe debate-api \
  --region asia-east1 \
  --format="yaml(spec.template.spec.containers[0].env)"
```

---

## ğŸ” é©—è­‰éƒ¨ç½²

### å¾Œç«¯å¥åº·æª¢æŸ¥

```bash
curl https://debate-api-1046434677262.asia-east1.run.app/health | python3 -m json.tool
```

é æœŸå›æ‡‰ï¼š

```json
{
  "status": "healthy",
  "version": "0.4.0",
  "phase": "4",
  "has_groq_key": true,
  "use_fake_stream": false,
  "use_langgraph": true,
  "model": "openai/gpt-oss-120b",
  "supabase_enabled": true,
  "note": "Phase 4: Supabase debate history + i18n"
}
```

### å‰ç«¯æ¸¬è©¦

1. æ‰“é–‹éƒ¨ç½²å¾Œçš„ URLï¼ˆå¾ `wrangler pages deploy` è¼¸å‡ºä¸­ç²å–ï¼‰
2. é–‹å•Ÿç€è¦½å™¨é–‹ç™¼è€…å·¥å…·ï¼ˆF12ï¼‰â†’ Network æ¨™ç±¤
3. è¼¸å…¥è¾¯è«–ä¸»é¡Œ
4. é»æ“Šã€Œé–‹å§‹è¾¯è«–ã€
5. ç¢ºèªï¼š
   - âœ… Network è«‹æ±‚é€£æ¥åˆ°æ­£ç¢ºçš„ API URLï¼ˆä¸æ˜¯ localhostï¼‰
   - âœ… AI ä¸²æµæ­£å¸¸é¡¯ç¤º
   - âœ… æ²’æœ‰ CORS éŒ¯èª¤
   - âœ… æ­·å²è¨˜éŒ„å¯ä»¥è®€å–

### ğŸ”§ é©—è­‰å‰ç«¯ API URL æ˜¯å¦æ­£ç¢º

```bash
# åœ¨å»ºç½®å¾Œæª¢æŸ¥
cd frontend
find out -name "*.js" -type f -exec grep -l "debate-api-1046434677262.asia-east1.run.app" {} \; | head -1

# å¦‚æœæ‰¾ä¸åˆ°ï¼Œè¡¨ç¤ºç’°å¢ƒè®Šæ•¸æœªæ³¨å…¥ï¼Œéœ€è¦é‡æ–°å»ºç½®
if ! find out -name "*.js" -type f -exec grep -q "debate-api-1046434677262.asia-east1.run.app" {} \;; then
  echo "âŒ è­¦å‘Šï¼šå»ºç½®æª”æ¡ˆä¸­æ²’æœ‰æ‰¾åˆ°ç”Ÿç”¢ç’°å¢ƒ API URLï¼"
  echo "è«‹ç¢ºä¿ .env.production å­˜åœ¨ä¸¦é‡æ–°å»ºç½®"
fi
```

---

## ğŸ“ ç”Ÿç”¢ç’°å¢ƒ URL

| æœå‹™ | å¹³å°             | URL                                                 |
| ---- | ---------------- | --------------------------------------------------- |
| å‰ç«¯ | Cloudflare Pages | https://1c592c98.debate-ai.pages.dev ï¼ˆæœ€æ–°éƒ¨ç½²ï¼‰   |
| å‰ç«¯ | è‡ªè¨‚åŸŸå         | https://debateai.roy422.ggff.net ï¼ˆéœ€åœ¨ CF è¨­å®šï¼‰   |
| å¾Œç«¯ | Cloud Run        | https://debate-api-1046434677262.asia-east1.run.app |

---

## âš ï¸ å¸¸è¦‹å•é¡Œ

### 1. å‰ç«¯é€£æ¥åˆ° localhost:8000 è€Œéç”Ÿç”¢ç’°å¢ƒ

**ç—‡ç‹€**ï¼š
- ç€è¦½å™¨æ§åˆ¶å°å‡ºç¾ `Failed to load resource: net::ERR_BLOCKED_BY_CLIENT`
- Network æ¨™ç±¤é¡¯ç¤ºè«‹æ±‚ `localhost:8000`

**åŸå› **ï¼š
Next.js ç’°å¢ƒè®Šæ•¸åœ¨**å»ºç½®æ™‚**æ³¨å…¥ï¼Œè€Œéé‹è¡Œæ™‚ã€‚å¦‚æœå»ºç½®æ™‚æ²’æœ‰æ­£ç¢ºè¨­å®š `NEXT_PUBLIC_API_URL`ï¼Œæœƒä½¿ç”¨é è¨­å€¼ `http://localhost:8000`ã€‚

**è§£æ±ºæ–¹æ¡ˆ**ï¼š
```bash
cd frontend

# 1. ç¢ºä¿ .env.production å­˜åœ¨ä¸”æ­£ç¢º
cat > .env.production << 'EOF'
NEXT_PUBLIC_API_URL=https://debate-api-1046434677262.asia-east1.run.app
EOF

# 2. å®Œå…¨æ¸…é™¤èˆŠå»ºç½®
rm -rf .next out

# 3. é‡æ–°å»ºç½®ï¼ˆç’°å¢ƒè®Šæ•¸æœƒè¢«è®€å–ï¼‰
npm run build

# 4. é©—è­‰å»ºç½®çµæœ
if grep -r "localhost:8000" out/ 2>/dev/null; then
  echo "âŒ ä»æœ‰å•é¡Œï¼Œè«‹æª¢æŸ¥ .env.production"
else
  echo "âœ… æ­£ç¢ºï¼å¯ä»¥éƒ¨ç½²äº†"
fi

# 5. é‡æ–°éƒ¨ç½²
npx wrangler pages deploy out --project-name debate-ai
```

### 2. CORS éŒ¯èª¤

**ç—‡ç‹€**ï¼š
```
Access to fetch at 'https://debate-api-xxx.run.app' from origin 'https://xxx.pages.dev' has been blocked by CORS policy
```

**è§£æ±ºæ–¹æ¡ˆ**ï¼š
å¾Œç«¯å·²å…§å»º `RegexCORSMiddleware`ï¼Œæ”¯æ´ `*.pages.dev` å’Œ `*.ggff.net` åŸŸåã€‚å¦‚æœä½¿ç”¨å…¶ä»–åŸŸåï¼Œéœ€æ›´æ–°å¾Œç«¯ `ALLOWED_ORIGINS`ï¼š

```bash
gcloud run services update debate-api \
  --region asia-east1 \
  --set-env-vars ALLOWED_ORIGINS=https://your-custom-domain.com
```

### 3. å†·å•Ÿå‹•å»¶é²

**ç—‡ç‹€**ï¼š
é¦–æ¬¡è«‹æ±‚éœ€è¦ç­‰å¾… 10-15 ç§’

**åŸå› **ï¼š
Cloud Run `min-instances=0` æœƒåœ¨ç„¡æµé‡æ™‚è‡ªå‹•ç¸®å®¹åˆ° 0ï¼Œä¸‹æ¬¡è«‹æ±‚éœ€è¦å†·å•Ÿå‹•ã€‚

**è§£æ±ºæ–¹æ¡ˆ**ï¼š
- **è‡¨æ™‚æ–¹æ¡ˆ**ï¼šå‰ç«¯å·²è¨­å®š 30 ç§’è¶…æ™‚ï¼Œæœƒé¡¯ç¤ºã€Œå¼•æ“å¯èƒ½æ­£åœ¨å†·å•Ÿå‹•ã€æç¤º
- **æ°¸ä¹…æ–¹æ¡ˆ**ï¼ˆå¢åŠ æˆæœ¬ï¼‰ï¼š
  ```bash
  gcloud run services update debate-api \
    --region asia-east1 \
    --min-instances 1  # ä¿æŒè‡³å°‘ 1 å€‹å¯¦ä¾‹é‹è¡Œ
  ```

### 4. éƒ¨ç½²å¤±æ•—

```bash
# æŸ¥çœ‹ Cloud Run æ—¥èªŒ
gcloud run services logs read debate-api --region asia-east1 --limit 50

# æŸ¥çœ‹ç‰¹å®š revision çš„æ—¥èªŒ
gcloud run services logs read debate-api \
  --region asia-east1 \
  --filter="resource.labels.revision_name=debate-api-00012-fz9"
```

### 5. Supabase é€£æ¥å¤±æ•—

**ç—‡ç‹€**ï¼š
å¥åº·æª¢æŸ¥é¡¯ç¤º `"supabase_enabled": false`

**è§£æ±ºæ–¹æ¡ˆ**ï¼š
```bash
# ç¢ºèªç’°å¢ƒè®Šæ•¸å·²è¨­å®š
gcloud run services describe debate-api \
  --region asia-east1 \
  --format="yaml(spec.template.spec.containers[0].env)" | grep -E "SUPABASE"

# å¦‚æœç¼ºå°‘ï¼Œé‡æ–°è¨­å®š
gcloud run services update debate-api \
  --region asia-east1 \
  --set-env-vars SUPABASE_URL=https://xxx.supabase.co,SUPABASE_SERVICE_ROLE_KEY=eyJhbGc...
```

---

## ğŸ“Š éƒ¨ç½²æª¢æŸ¥æ¸…å–®

### Backend éƒ¨ç½²å‰

- [ ] `.env` æª”æ¡ˆåŒ…å«æ‰€æœ‰å¿…è¦ç’°å¢ƒè®Šæ•¸
- [ ] Groq API Key æœ‰æ•ˆ
- [ ] Supabase å°ˆæ¡ˆå·²å»ºç«‹ä¸¦å–å¾— Service Role Key
- [ ] æ¸¬è©¦æœ¬æ©Ÿé‹è¡Œï¼š`uv run uvicorn app.main:app --reload`

### Backend éƒ¨ç½²å¾Œ

- [ ] Health check è¿”å› `"status": "healthy"`
- [ ] `has_groq_key`: true
- [ ] `supabase_enabled`: true
- [ ] `use_langgraph`: true

### Frontend éƒ¨ç½²å‰

- [ ] `.env.production` åŒ…å«æ­£ç¢ºçš„ `NEXT_PUBLIC_API_URL`
- [ ] æ¸…é™¤èˆŠå»ºç½®ï¼š`rm -rf .next out`
- [ ] å»ºç½®æˆåŠŸï¼š`npm run build`
- [ ] é©—è­‰ç„¡ localhostï¼š`! grep -r "localhost:8000" out/`

### Frontend éƒ¨ç½²å¾Œ

- [ ] é é¢å¯æ­£å¸¸è¨ªå•
- [ ] Network è«‹æ±‚é€£æ¥åˆ°ç”Ÿç”¢ APIï¼ˆé localhostï¼‰
- [ ] ç„¡ CORS éŒ¯èª¤
- [ ] è¾¯è«–åŠŸèƒ½æ­£å¸¸
- [ ] æ­·å²è¨˜éŒ„å¯è®€å–
- [ ] ä¸­è‹±åˆ‡æ›æ­£å¸¸

---

## ğŸš€ å®Œæ•´éƒ¨ç½²è…³æœ¬

### ä¸€éµéƒ¨ç½² Backend

```bash
#!/bin/bash
cd backend

# è®€å– .env ä¸­çš„ç’°å¢ƒè®Šæ•¸
source .env

# éƒ¨ç½²åˆ° Cloud Run
gcloud run deploy debate-api \
  --source . \
  --region asia-east1 \
  --set-env-vars GROQ_API_KEY=${GROQ_API_KEY},GROQ_MODEL=${GROQ_MODEL:-openai/gpt-oss-120b},TAVILY_API_KEY=${TAVILY_API_KEY},USE_LANGGRAPH=true,SUPABASE_SERVICE_ROLE_KEY=${SUPABASE_SERVICE_ROLE_KEY},SUPABASE_URL=${SUPABASE_URL} \
  --memory 512Mi \
  --cpu 1 \
  --timeout 300 \
  --min-instances 0 \
  --max-instances 3 \
  --allow-unauthenticated

# é©—è­‰éƒ¨ç½²
echo "ğŸ” é©—è­‰ Backend..."
curl -s https://debate-api-1046434677262.asia-east1.run.app/health | python3 -m json.tool
```

### ä¸€éµéƒ¨ç½² Frontend

```bash
#!/bin/bash
cd frontend

# ç¢ºä¿ç’°å¢ƒè®Šæ•¸æ­£ç¢º
cat > .env.production << 'EOF'
NEXT_PUBLIC_API_URL=https://debate-api-1046434677262.asia-east1.run.app
EOF

# æ¸…é™¤ä¸¦é‡æ–°å»ºç½®
echo "ğŸ”¨ æ¸…é™¤èˆŠå»ºç½®..."
rm -rf .next out

echo "ğŸ“¦ å»ºç½®ä¸­..."
npm run build

# é©—è­‰å»ºç½®
echo "ğŸ” é©—è­‰å»ºç½®çµæœ..."
if grep -r "localhost:8000" out/ 2>/dev/null; then
  echo "âŒ éŒ¯èª¤ï¼šå»ºç½®ä¸­ä»åŒ…å« localhostï¼"
  exit 1
fi

echo "âœ… å»ºç½®é©—è­‰é€šé"

# éƒ¨ç½²
echo "ğŸš€ éƒ¨ç½²åˆ° Cloudflare Pages..."
npx wrangler pages deploy out --project-name debate-ai

echo "âœ… éƒ¨ç½²å®Œæˆï¼"
```

---

## ğŸ“š ç›¸é—œæ–‡ä»¶

- [Google Cloud Run æ–‡ä»¶](https://cloud.google.com/run/docs)
- [Cloudflare Pages æ–‡ä»¶](https://developers.cloudflare.com/pages/)
- [Next.js ç’°å¢ƒè®Šæ•¸](https://nextjs.org/docs/app/building-your-application/configuring/environment-variables)
- [Wrangler CLI](https://developers.cloudflare.com/workers/wrangler/)
